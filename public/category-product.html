<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Products - PULSE PARCLE</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/animejs/lib/anime.iife.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-orange: #FF7A2F;
            --secondary-brown: #3E2723;
            --accent-cream: #FFF6ED;
            --neutral-gray: #555555;
            --light-gray: #EDEDED;
            --alert-red: #EF4444;
        }
        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--accent-cream);
            color: var(--secondary-brown);
        }

        .back-button {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 42px;
            height: 42px;
            background: rgba(0,0,0,0.06);
            border-radius: 50%;
            transition: all 0.2s ease;
        }
        .back-button:hover { background: rgba(0,0,0,0.12); }

        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        .product-image-container { aspect-ratio: 1 / 1; overflow: hidden; }

        .ripple { position: relative; overflow: hidden; }
        .ripple:after {
            content: ""; position: absolute; width: 100%; height: 100%; top: 0; left: 0;
            pointer-events: none; background-image: radial-gradient(circle, #fff 10%, transparent 10.01%);
            background-repeat: no-repeat; background-position: 50%; transform: scale(10,10); opacity: 0;
            transition: transform .5s, opacity 1s;
        }
        .ripple:active:after { transform: scale(0,0); opacity: .3; transition: 0s; }

        .toast {
            position: fixed; top: 1rem; right: 1rem; padding: 0.75rem 1.5rem; border-radius: 50px; z-index: 100;
            opacity: 0; transform: translateY(-20px); transition: all 0.3s; font-size: 0.875rem; font-weight: 500;
        }
        .toast.show { opacity: 1; transform: translateY(0); }
        .toast.success { background: #10B981; color: white; }
        .toast.error { background: var(--alert-red); color: white; }

        .shimmer { background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; }
        @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }

        .image-modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 60; align-items: center; justify-content: center; }
        .image-modal.show { display: flex; }
        .image-modal-content img { max-width: 90%; max-height: 90%; object-fit: contain; }
        .image-modal-nav { position: absolute; top: 50%; transform: translateY(-50%); background: rgba(0,0,0,0.5); color: white; padding: 1rem; border-radius: 50%; cursor: pointer; }
        .image-modal-nav.prev { left: 1rem; } .image-modal-nav.next { right: 1rem; }
        .image-modal-close { position: absolute; top: 1rem; right: 1rem; color: white; font-size: 2rem; cursor: pointer; }
    </style>
</head>
<body class="min-h-screen">

    <!-- Clean Header: Back + Centered Title -->
    <header class="bg-white shadow-sm sticky top-0 z-50">
        <div class="container mx-auto px-4 py-4 flex items-center justify-between relative">
            <button onclick="history.back()" class="back-button ripple" aria-label="Go back">
                <i data-feather="arrow-left" class="w-6 h-6 text-neutral-gray"></i>
            </button>
            <h1 class="absolute left-1/2 transform -translate-x-1/2 text-lg font-bold text-neutral-gray" id="category-title">Products</h1>
            <div class="w-10 h-10"></div>
        </div>
    </header>

    <!-- Mobile Search -->
    <div class="container mx-auto px-4 py-4">
        <div class="relative">
            <input type="text" id="mobile-search" placeholder="Search products..." 
                   class="w-full py-3 px-4 rounded-full border border-gray-300 focus:outline-none focus:ring-2 focus:ring-orange-500">
            <i data-feather="search" class="absolute right-4 top-3.5 text-neutral-gray w-5 h-5"></i>
        </div>
    </div>

    <!-- Full Image Modal -->
    <div id="image-modal" class="image-modal">
        <div class="image-modal-content">
            <span class="image-modal-close">&times;</span>
            <img id="full-image" src="" alt="Full product image">
            <button class="image-modal-nav prev"><i data-feather="chevron-left" class="w-8 h-8"></i></button>
            <button class="image-modal-nav next"><i data-feather="chevron-right" class="w-8 h-8"></i></button>
        </div>
    </div>

    <main class="container mx-auto px-4 py-6">
        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4" id="product-list">
            <!-- Shimmer placeholders -->
            <div class="bg-white rounded-xl p-4 shadow-sm"><div class="w-full h-40 bg-gray-200 rounded-lg shimmer mb-3"></div><div class="h-5 w-3/4 bg-gray-200 rounded shimmer mb-2"></div><div class="h-4 w-1/2 bg-gray-200 rounded shimmer"></div></div>
            <div class="bg-white rounded-xl p-4 shadow-sm"><div class="w-full h-40 bg-gray-200 rounded-lg shimmer mb-3"></div><div class="h-5 w-3/4 bg-gray-200 rounded shimmer mb-2"></div><div class="h-4 w-1/2 bg-gray-200 rounded shimmer"></div></div>
            <div class="bg-white rounded-xl p-4 shadow-sm"><div class="w-full h-40 bg-gray-200 rounded-lg shimmer mb-3"></div><div class="h-5 w-3/4 bg-gray-200 rounded shimmer mb-2"></div><div class="h-4 w-1/2 bg-gray-200 rounded shimmer"></div></div>
            <div class="bg-white rounded-xl p-4 shadow-sm"><div class="w-full h-40 bg-gray-200 rounded-lg shimmer mb-3"></div><div class="h-5 w-3/4 bg-gray-200 rounded shimmer mb-2"></div><div class="h-4 w-1/2 bg-gray-200 rounded shimmer"></div></div>
        </div>
    </main>

    <!-- Floating Chat -->
   

    <!-- BOTTOM NAVIGATION REMOVED -->

    <script>
        feather.replace();
        const API_BASE_URL = 'https://pulse-parcel.onrender.com/api';
        let productImages = [], currentImageIndex = 0;

        function showToast(msg, type='success'){
            const t=document.createElement('div');t.className=`toast ${type} shadow-lg`;t.textContent=msg;document.body.appendChild(t);
            setTimeout(()=>t.classList.add('show'),100);
            setTimeout(()=>{t.classList.remove('show');setTimeout(()=>t.remove(),300);},3000);
        }

        function showFullImage(images, index){
            productImages = images; currentImageIndex = index;
            document.getElementById('full-image').src = images[index]?.url || '/images/placeholder.jpg';
            document.getElementById('image-modal').classList.add('show');
            feather.replace();
        }

        document.getElementById('image-modal').addEventListener('click', e => {
            if (e.target === document.getElementById('image-modal') || e.target.classList.contains('image-modal-close')) {
                document.getElementById('image-modal').classList.remove('show');
            }
        });
        document.querySelector('.image-modal-nav.prev').onclick = () => showFullImage(productImages, (currentImageIndex - 1 + productImages.length) % productImages.length);
        document.querySelector('.image-modal-nav.next').onclick = () => showFullImage(productImages, (currentImageIndex + 1) % productImages.length);

        async function fetchCategoryName(id){
            try{
                const res = await fetch(`${API_BASE_URL}/public/categories/${id}`);
                const cat = await res.json();
                document.getElementById('category-title').textContent = `${cat.name} Products`;
            }catch{ document.getElementById('category-title').textContent = 'Products'; }
        }

        async function fetchProducts(query=''){
            const res = await fetch(`${API_BASE_URL}/public/products?${query}`);
            const products = await res.json();
            const container = document.getElementById('product-list');
            container.innerHTML = products.length === 0 ? '<p class="col-span-full text-center text-gray-600">No products found</p>' : products.map(p => `
                <div class="bg-white rounded-xl p-4 shadow-sm transition-all hover:shadow-lg">
                    <div class="relative product-image-container cursor-pointer ripple" onclick="showFullImage(${JSON.stringify(p.images || [])}, 0)">
                        <a href="/product.html?id=${p._id}">
                            <img src="${p.images?.[0]?.url || '/images/placeholder.jpg'}" alt="${p.name}" class="w-full h-full object-contain">
                            ${p.discount ? `<div class="absolute top-2 left-2 bg-orange-500 text-white text-xs px-2 py-1 rounded">-${p.discount}%</div>` : ''}
                        </a>
                    </div>
                    <h3 class="text-sm font-medium mt-3 truncate">${p.name}</h3>
                    <div class="flex items-center mt-1 text-xs text-gray-600">
                        <div class="flex text-yellow-400">${'★'.repeat(Math.round(p.rating || 0))}${'☆'.repeat(5-Math.round(p.rating || 0))}</div>
                        <span class="ml-1">(${p.reviews?.length || 0})</span>
                    </div>
                    <div class="flex justify-between items-center mt-2">
                        <p class="text-orange-500 font-bold">₦${p.price.toLocaleString()}</p>
                        <div class="flex gap-3">
                            <button class="ripple add-to-cart-btn" data-product-id="${p._id}"><i data-feather="shopping-cart" class="w-5 h-5"></i></button>
                            <button class="ripple" onclick="toggleWishlist('${p._id}', this)"><i data-feather="heart" class="w-5 h-5"></i></button>
                        </div>
                    </div>
                </div>
            `).join('');
            feather.replace();
            document.querySelectorAll('.add-to-cart-btn').forEach(b => b.onclick = () => addToCart(b.dataset.productId, 1));
        }

        async function addToCart(id, qty=1){
            const token = localStorage.getItem('token');
            if(token){
                await fetch(`${API_BASE_URL}/carts/add`, {method:'POST',headers:{'Content-Type':'application/json','Authorization':`Bearer ${token}`},body:JSON.stringify({productId:id,quantity:qty})});
                showToast('Added to cart','success');
            }else{
                let cart = JSON.parse(localStorage.getItem('guestCart')||'[]');
                const i = cart.find(x=>x.productId===id);
                i ? i.quantity += qty : cart.push({productId:id,quantity:qty});
                localStorage.setItem('guestCart',JSON.stringify(cart));
                showToast('Added to cart (guest)','success');
            }
        }

        function toggleWishlist(id, btn){
            const heart = btn.querySelector('svg');
            const token = localStorage.getItem('token');
            if(token){
                fetch(`${API_BASE_URL}/wishlist/toggle`,{method:'POST',headers:{'Content-Type':'application/json','Authorization':`Bearer ${token}`},body:JSON.stringify({productId:id})});
            }
            heart.classList.toggle('fill-current'); heart.classList.toggle('text-red-500');
        }

        document.getElementById('mobile-search').oninput = e => {
            const q = e.target.value.trim();
            const params = new URLSearchParams(location.search);
            const base = params.get('category') ? `category=${params.get('category')}` : params.get('isBestSeller') ? 'isBestSeller=true' : 'isFlashDeal=true';
            fetchProducts(base + (q ? `&search=${encodeURIComponent(q)}` : ''));
        };

        document.addEventListener('DOMContentLoaded', () => {
            const params = new URLSearchParams(location.search);
            const cat = params.get('category');
            const best = params.get('isBestSeller');
            const flash = params.get('isFlashDeal');
            if(cat) fetchCategoryName(cat);
            else if(best) document.getElementById('category-title').textContent = 'Best Sellers';
            else if(flash) document.getElementById('category-title').textContent = 'Flash Deals';

            const query = cat ? `category=${cat}` : best ? 'isBestSeller=true' : flash ? 'isFlashDeal=true' : '';
            fetchProducts(query);
        });
    </script>
</body>
</html>