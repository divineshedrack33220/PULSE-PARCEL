<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Account - PULSE PARCLE</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-orange: #FF7A2F;
            --secondary-brown: #3E2723;
            --accent-cream: #FFF6ED;
            --neutral-gray: #555555;
            --light-gray: #EDEDED;
            --alert-red: #EF4444;
        }
        
        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--accent-cream);
            color: var(--secondary-brown);
        }

        .back-button {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 42px;
            height: 42px;
            background: rgba(0,0,0,0.06);
            border-radius: 50%;
            transition: all 0.2s ease;
        }

        .back-button:hover {
            background: rgba(0,0,0,0.12);
        }
        
        .ripple {
            position: relative;
            overflow: hidden;
        }
        
        .ripple:after {
            content: "";
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            pointer-events: none;
            background-image: radial-gradient(circle, #fff 10%, transparent 10.01%);
            background-repeat: no-repeat;
            background-position: 50%;
            transform: scale(10,10);
            opacity: 0;
            transition: transform .5s, opacity 1s;
        }
        
        .ripple:active:after {
            transform: scale(0,0);
            opacity: .3;
            transition: 0s;
        }
        
        .profile-card:hover, .account-option:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        
        .faq-item {
            cursor: pointer;
        }
        
        .faq-answer {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }
        
        .faq-item.active .faq-answer {
            max-height: 200px;
        }
        
        .faq-item.active .chevron {
            transform: rotate(180deg);
        }

        .shimmer {
            position: relative;
            overflow: hidden;
            background-color: var(--light-gray);
            border-radius: 4px;
        }

        .shimmer::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                90deg,
                transparent,
                rgba(255, 255, 255, 0.4),
                transparent
            );
            animation: shimmer 1.5s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 100;
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background-color: white;
            border-radius: 12px;
            padding: 1.5rem;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }
    </style>
</head>
<body class="min-h-screen">

    <!-- Clean Header: Back Button + Centered Title -->
    <header class="bg-white shadow-sm sticky top-0 z-50">
        <div class="container mx-auto px-4 py-4 flex items-center justify-between relative">
            <!-- Back Button -->
            <button onclick="history.back()" class="back-button ripple" aria-label="Go back">
                <i data-feather="arrow-left" class="w-6 h-6 text-neutral-gray"></i>
            </button>

            <!-- Centered Title -->
            <h1 class="absolute left-1/2 transform -translate-x-1/2 text-lg font-bold text-neutral-gray">
                My Account
            </h1>

            <!-- Spacer for balance -->
            <div class="w-10 h-10"></div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-6">
        <!-- Profile Section -->
        <section class="mb-8">
            <div class="profile-card bg-white rounded-xl p-6 shadow-sm mb-4 transition-all duration-300">
                <div class="flex items-center mb-4" id="profile-content">
                    <div class="w-20 h-20 rounded-full bg-orange-100 flex items-center justify-center mr-4 overflow-hidden">
                        <img id="profile-picture" class="w-full h-full object-cover hidden" alt="Profile Picture">
                        <i data-feather="user" class="w-10 h-10 text-orange-500" id="profile-icon"></i>
                    </div>
                    <div>
                        <div class="h-6 w-32 mb-2 shimmer" id="user-name"></div>
                        <div class="h-4 w-48 mb-1 shimmer" id="user-email"></div>
                        <div class="h-4 w-36 shimmer" id="user-phone"></div>
                    </div>
                </div>
                <button class="w-full py-3 bg-orange-500 text-white rounded-full font-medium ripple" id="edit-profile-btn">Edit Profile</button>
            </div>
        </section>

        <!-- Edit Profile Modal -->
        <div class="modal" id="edit-profile-modal">
            <div class="modal-content">
                <h3 class="text-lg font-bold mb-4">Edit Profile</h3>
                <div id="modal-error" class="hidden text-sm text-red-500 mb-2"></div>
                <div class="mb-4">
                    <label for="modal-name" class="block text-sm font-medium mb-1">Name</label>
                    <input type="text" id="modal-name" class="w-full py-2 px-4 rounded-full border border-gray-300 focus:outline-none focus:ring-2 focus:ring-orange-500" placeholder="Enter your name">
                </div>
                <div class="mb-4">
                    <label for="modal-phone" class="block text-sm font-medium mb-1">Phone Number</label>
                    <input type="tel" id="modal-phone" class="w-full py-2 px-4 rounded-full border border-gray-300 focus:outline-none focus:ring-2 focus:ring-orange-500" placeholder="Enter your phone number">
                </div>
                <div class="flex space-x-4">
                    <button class="w-1/2 py-2 bg-orange-500 text-white rounded-full font-medium ripple" id="save-profile-btn">Save</button>
                    <button class="w-1/2 py-2 bg-gray-200 text-gray-700 rounded-full font-medium ripple" id="cancel-profile-btn">Cancel</button>
                </div>
            </div>
        </div>

        <!-- Logout Confirmation Modal -->
        <div class="modal" id="logout-confirmation-modal">
            <div class="modal-content">
                <h3 class="text-lg font-bold mb-4">Confirm Logout</h3>
                <p class="text-sm text-gray-500 mb-4">Are you sure you want to log out of your account?</p>
                <div class="flex space-x-4">
                    <button class="w-1/2 py-2 bg-orange-500 text-white rounded-full font-medium ripple" id="confirm-logout-btn">Yes, Logout</button>
                    <button class="w-1/2 py-2 bg-gray-200 text-gray-700 rounded-full font-medium ripple" id="cancel-logout-btn">Cancel</button>
                </div>
            </div>
        </div>

        <!-- Account Options -->
        <section class="mb-8">
            <h2 class="text-xl font-bold mb-4">Account Options</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <a href="/saved-addresses.html" class="account-option bg-white rounded-xl p-4 shadow-sm flex items-center transition-all duration-300 ripple">
                    <i data-feather="map-pin" class="w-6 h-6 text-orange-500 mr-3"></i>
                    <div>
                        <p class="text-sm font-medium">Saved Addresses</p>
                        <p class="text-xs text-gray-500">Manage delivery addresses</p>
                    </div>
                </a>
                <!-- <a href="/payment-methods.html" class="account-option bg-white rounded-xl p-4 shadow-sm flex items-center transition-all duration-300 ripple">
                    <i data-feather="credit-card" class="w-6 h-6 text-orange-500 mr-3"></i>
                    <div>
                        <p class="text-sm font-medium">Payment Methods</p>
                        <p class="text-xs text-gray-500">Add or edit payment options</p>
                    </div>
                </a> -->
                <a href="/wishlist.html" class="account-option bg-white rounded-xl p-4 shadow-sm flex items-center transition-all duration-300 ripple">
                    <i data-feather="heart" class="w-6 h-6 text-orange-500 mr-3"></i>
                    <div>
                        <p class="text-sm font-medium">Wishlist</p>
                        <p class="text-xs text-gray-500">View your saved items</p>
                    </div>
                </a>
                <a href="/account-security.html" class="account-option bg-white rounded-xl p-4 shadow-sm flex items-center transition-all duration-300 ripple">
                    <i data-feather="lock" class="w-6 h-6 text-orange-500 mr-3"></i>
                    <div>
                        <p class="text-sm font-medium">Account Security</p>
                        <p class="text-xs text-gray-500">Manage password & security</p>
                    </div>
                </a>
                <button class="account-option bg-white rounded-xl p-4 shadow-sm flex items-center transition-all duration-300 ripple" id="logout-btn">
                    <i data-feather="log-out" class="w-6 h-6 text-orange-500 mr-3"></i>
                    <div>
                        <p class="text-sm font-medium">Logout</p>
                        <p class="text-xs text-gray-500">Sign out of your account</p>
                    </div>
                </button>
            </div>
        </section>

        <!-- Support Information -->
        <section class="mb-8">
            <h2 class="text-xl font-bold mb-4">Support Information</h2>
            <div class="bg-white rounded-xl p-4 shadow-sm">
                <p class="text-sm font-medium mb-2">Need Help?</p>
                <p class="text-sm text-gray-500 mb-4">Contact our support team for assistance with your orders, returns, or any inquiries.</p>
                <div class="flex items-center mb-2">
                    <i data-feather="phone" class="w-5 h-5 text-orange-500 mr-3"></i>
                    <p class="text-sm">+234 800 123 4567</p>
                </div>
                <div class="flex items-center mb-2">
                    <i data-feather="mail" class="w-5 h-5 text-orange-500 mr-3"></i>
                    <p class="text-sm">support@pulseparcle.com</p>
                </div>
                <a href="/chat.html" class="inline-block py-2 px-4 bg-green-500 text-white rounded-full font-medium ripple mt-2">Live Chat</a>
            </div>
        </section>

        <!-- FAQ Section -->
        <section class="mb-8">
            <h2 class="text-xl font-bold mb-4">Frequently Asked Questions</h2>
            <div class="bg-white rounded-xl p-4 shadow-sm">
                <div class="faq-item mb-4">
                    <p class="text-sm font-medium flex items-center justify-between">How can I track my order? <i data-feather="chevron-down" class="w-5 h-5 chevron"></i></p>
                    <div class="faq-answer text-sm text-gray-500 mt-2">
                        You can track your order by visiting the "My Orders" section in your account. Click on an active order to view its tracking details, including the current status and estimated delivery date.
                    </div>
                </div>
                <div class="faq-item mb-4">
                    <p class="text-sm font-medium flex items-center justify-between">What is your return policy? <i data-feather="chevron-down" class="w-5 h-5 chevron"></i></p>
                    <div class="faq-answer text-sm text-gray-500 mt-2">
                        We offer a 7-day return policy for eligible items. To initiate a return, go to "My Orders," select the order, and follow the return instructions. Ensure the item is unused and in its original packaging.
                    </div>
                </div>
                <div class="faq-item">
                    <p class="text-sm font-medium flex items-center justify-between">How do I update my payment method? <i data-feather="chevron-down" class="w-5 h-5 chevron"></i></p>
                    <div class="faq-answer text-sm text-gray-500 mt-2">
                        Navigate to "Payment Methods" in your account to add, edit, or remove payment options. We support various methods, including cards and mobile payments.
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Floating WhatsApp Button
    <div class="fixed bottom-24 right-4 z-20">
        <button class="bg-green-500 text-white p-3 rounded-full shadow-lg hover:bg-green-600 transition-colors ripple" onclick="window.location.href='/chat.html'">
            <i data-feather="message-circle" class="w-6 h-6"></i>
        </button>
    </div> -->

    <!-- BOTTOM NAVIGATION REMOVED -->

    <script>
        feather.replace();

        const API_BASE_URL = 'https://pulse-parcel.onrender.com/api';

        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type} shadow-lg`;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => { toast.classList.add('show'); }, 100);
            setTimeout(() => { toast.classList.remove('show'); setTimeout(() => { toast.remove(); }, 300); }, 2000);
        }

        function checkAuth() {
            const token = localStorage.getItem('token');
            if (!token) {
                showToast('Please log in to view your profile', 'error');
                setTimeout(() => { window.location.href = '/login.html?redirect=profile'; }, 2000);
                return false;
            }
            return true;
        }

        async function mergeGuestCart() {
            try {
                const token = localStorage.getItem('token');
                const guestCart = JSON.parse(localStorage.getItem('guestCart') || '[]');
                if (guestCart.length > 0) {
                    const response = await fetch(`${API_BASE_URL}/carts/merge`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`,
                        },
                        body: JSON.stringify({ cart: guestCart }),
                    });
                    if (!response.ok) throw new Error('Failed to merge cart');
                    localStorage.removeItem('guestCart');
                    showToast('Guest cart merged successfully', 'success');
                }
            } catch (error) {
                console.error('Error merging guest cart:', error);
                showToast(`Failed to merge guest cart: ${error.message}`, 'error');
            }
        }

        async function fetchCart() {
            try {
                const token = localStorage.getItem('token');
                let cart = [];
                if (token) {
                    const response = await fetch(`${API_BASE_URL}/carts/me`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (!response.ok) throw new Error('Failed to fetch cart');
                    cart = (await response.json()).items || [];
                } else {
                    cart = JSON.parse(localStorage.getItem('guestCart') || '[]');
                }
                updateCartCount(cart);
            } catch (error) {
                console.error('Error fetching cart:', error);
                showToast(`Failed to load cart: ${error.message}`, 'error');
            }
        }

        async function fetchProfile() {
            if (!checkAuth()) return;
            try {
                const token = localStorage.getItem('token');
                const userResponse = await fetch(`${API_BASE_URL}/users/profile`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!userResponse.ok) throw new Error('Failed to fetch profile');
                const user = await userResponse.json();
                renderProfile(user);
                await mergeGuestCart();
            } catch (error) {
                console.error('Error fetching profile:', error);
                document.querySelector('#profile-content').innerHTML = '<p class="text-center text-neutral-gray">Failed to load profile. Please try again.</p>';
                showToast(`Failed to load profile: ${error.message}`, 'error');
            }
        }

        function renderProfile(user) {
            const profileContent = document.querySelector('#profile-content');
            profileContent.innerHTML = `
                <div class="flex items-center mb-4">
                    <div class="w-20 h-20 rounded-full bg-orange-100 flex items-center justify-center mr-4 overflow-hidden">
                        <img id="profile-picture" class="w-full h-full object-cover ${user.picture ? '' : 'hidden'}" alt="Profile Picture" src="${user.picture || ''}">
                        <i data-feather="user" class="w-10 h-10 text-orange-500 ${user.picture ? 'hidden' : ''}" id="profile-icon"></i>
                    </div>
                    <div>
                        <h3 class="text-lg font-bold" id="user-name">${user.name || 'User'}</h3>
                        <p class="text-sm text-gray-500" id="user-email">${user.email || 'No email provided'}</p>
                        <p class="text-sm text-gray-500" id="user-phone">${user.phone || 'No phone number provided'}</p>
                    </div>
                </div>
            `;
            document.querySelector('#modal-name').value = user.name || '';
            document.querySelector('#modal-phone').value = user.phone || '';
            feather.replace();
        }

        function showModal() {
            document.querySelector('#edit-profile-modal').classList.add('show');
            document.querySelector('#modal-error').classList.add('hidden');
        }

        function hideModal() {
            document.querySelector('#edit-profile-modal').classList.remove('show');
            document.querySelector('#modal-error').classList.add('hidden');
        }

        function showLogoutModal() {
            document.querySelector('#logout-confirmation-modal').classList.add('show');
        }

        function hideLogoutModal() {
            document.querySelector('#logout-confirmation-modal').classList.remove('show');
        }

        function logout() {
            showLogoutModal();
        }

        async function saveProfile() {
            const name = document.querySelector('#modal-name').value.trim();
            const phone = document.querySelector('#modal-phone').value.trim();
            const modalError = document.querySelector('#modal-error');

            if (!name || !phone) {
                modalError.textContent = 'Name and phone number are required.';
                modalError.classList.remove('hidden');
                return;
            }

            const phoneRegex = /^\+?\d{10,15}$/;
            if (!phoneRegex.test(phone)) {
                modalError.textContent = 'Please enter a valid phone number (10-15 digits).';
                modalError.classList.remove('hidden');
                return;
            }

            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_BASE_URL}/users/profile`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`,
                    },
                    body: JSON.stringify({ name, phone }),
                });
                if (!response.ok) throw new Error('Failed to update profile');
                const user = await response.json();
                renderProfile(user);
                hideModal();
                showToast('Profile updated successfully', 'success');
            } catch (error) {
                console.error('Error updating profile:', error);
                modalError.textContent = `Failed to update profile: ${error.message}`;
                modalError.classList.remove('hidden');
            }
        }

        function setupLogoutModal() {
            document.querySelector('#confirm-logout-btn').addEventListener('click', () => {
                localStorage.removeItem('token');
                showToast('Logged out successfully', 'success');
                hideLogoutModal();
                setTimeout(() => { window.location.href = '/login.html'; }, 2000);
            });
            document.querySelector('#cancel-logout-btn').addEventListener('click', hideLogoutModal);
        }

        function updateCartCount(cartItems) {
            const count = cartItems.reduce((sum, item) => sum + item.quantity, 0);
            const badge = document.querySelector('#bottom-cart-count');
            if (badge) {
                badge.textContent = count;
                badge.classList.toggle('animate-bounce', count > 0);
            }
        }

        function setupRippleEffect() {
            document.querySelectorAll('.ripple').forEach(button => {
                button.addEventListener('click', function(e) {
                    const rect = this.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;
                    this.style.setProperty('--x', x + 'px');
                    this.style.setProperty('--y', y + 'px');
                });
            });
        }

        function setupFaqToggle() {
            document.querySelectorAll('.faq-item').forEach(item => {
                item.addEventListener('click', () => {
                    item.classList.toggle('active');
                    feather.replace();
                });
            });
        }

        function setupModal() {
            document.querySelector('#edit-profile-btn').addEventListener('click', showModal);
            document.querySelector('#save-profile-btn').addEventListener('click', saveProfile);
            document.querySelector('#cancel-profile-btn').addEventListener('click', hideModal);
        }

        document.addEventListener('DOMContentLoaded', () => {
            feather.replace();
            setTimeout(() => {
                if (checkAuth()) {
                    fetchProfile();
                    setupRippleEffect();
                    setupFaqToggle();
                    setupModal();
                    setupLogoutModal();
                    document.querySelector('#logout-btn').addEventListener('click', logout);
                }
            }, 100);
        });
    </script>
</body>
</html>