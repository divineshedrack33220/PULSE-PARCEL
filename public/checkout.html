<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout -  PULSE PARCLE </title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-orange: #FF7A2F;
            --secondary-brown: #3E2723;
            --accent-cream: #FFF6ED;
            --neutral-gray: #555555;
            --light-gray: #EDEDED;
            --alert-red: #EF4444;
            --modal-display: none;
        }
        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--accent-cream);
            color: var(--secondary-brown);
        }
        .payment-method {
            transition: all 0.3s ease;
        }
        .payment-method.active {
            border-color: var(--primary-orange);
            background-color: rgba(255, 122, 47, 0.05);
        }
        .ripple {
            position: relative;
            overflow: hidden;
        }
        .ripple:after {
            content: "";
            display: block;
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            pointer-events: none;
            background-image: radial-gradient(circle, #fff 10%, transparent 10.01%);
            background-repeat: no-repeat;
            background-position: 50%;
            transform: scale(10,10);
            opacity: 0;
            transition: transform .5s, opacity 1s;
        }
        .ripple:active:after {
            transform: scale(0,0);
            opacity: .3;
            transition: 0s;
        }
        .toast {
            position: fixed;
            top: 0.5rem;
            right: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 30px;
            z-index: 50;
            opacity: 0;
            transform: translateY(-20px);
            transition: opacity 0.3s ease, transform 0.3s ease;
            font-size: 0.75rem;
            line-height: 1rem;
        }
        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }
        .toast.success {
            background-color: #10B981;
            color: white;
        }
        .toast.error {
            background-color: var(--alert-red);
            color: white;
        }
        #payment-modal, #proof-modal {
            display: var(--modal-display);
        }
        #payment-modal.hidden, #proof-modal.hidden {
            display: none;
        }
        @media (min-width: 768px) {
            .bottom-nav {
                display: none;
            }
        }
        .checkout-loader {
            animation: shimmer 1.5s infinite linear;
            background: linear-gradient(to right, #f6f6f6 0%, #edeef1 20%, #f6f6f6 40%, #f6f6f6 100%);
            background-size: 200% 100%;
        }
        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
    </style>
</head>
<body class="min-h-screen pb-24 md:pb-0">
    <header class="bg-white shadow-sm sticky top-0 z-10" role="banner">
        <div class="container mx-auto px-4 py-3 flex items-center justify-between">
            <button onclick="history.back()" class="p-2 rounded-full hover:bg-gray-100 ripple" aria-label="Go back">
                <i data-feather="arrow-left" class="text-gray-700" aria-hidden="true"></i>
            </button>
            <h1 class="text-lg font-bold" aria-label="Checkout page">Checkout</h1>
            <div class="flex items-center space-x-4" id="auth-links"></div>
        </div>
    </header>
    <main class="container mx-auto px-4 py-4 md:px-6 lg:max-w-4xl" role="main">
        <div id="checkout-loader" class="space-y-4 hidden">
            <div class="bg-white rounded-xl p-4 shadow-sm">
                <div class="h-6 w-1/2 bg-gray-200 rounded checkout-loader mb-3"></div>
                <div class="bg-gray-50 p-3 rounded-lg space-y-2">
                    <div class="h-4 w-1/3 bg-gray-200 rounded checkout-loader"></div>
                    <div class="h-4 w-1/4 bg-gray-200 rounded checkout-loader"></div>
                    <div class="h-4 w-3/4 bg-gray-200 rounded checkout-loader"></div>
                </div>
            </div>
            <div class="bg-white rounded-xl p-4 shadow-sm">
                <div class="h-6 w-1/2 bg-gray-200 rounded checkout-loader mb-3"></div>
                <div class="space-y-2">
                    <div class="flex justify-between">
                        <div class="h-4 w-1/2 bg-gray-200 rounded checkout-loader"></div>
                        <div class="h-4 w-1/4 bg-gray-200 rounded checkout-loader"></div>
                    </div>
                    <div class="flex justify-between">
                        <div class="h-4 w-1/2 bg-gray-200 rounded checkout-loader"></div>
                        <div class="h-4 w-1/4 bg-gray-200 rounded checkout-loader"></div>
                    </div>
                    <div class="flex justify-between">
                        <div class="h-4 w-1/2 bg-gray-200 rounded checkout-loader"></div>
                        <div class="h-4 w-1/4 bg-gray-200 rounded checkout-loader"></div>
                    </div>
                </div>
                <div class="border-t border-gray-200 pt-3 mt-3">
                    <div class="flex justify-between">
                        <div class="h-4 w-1/3 bg-gray-200 rounded checkout-loader"></div>
                        <div class="h-4 w-1/4 bg-gray-200 rounded checkout-loader"></div>
                    </div>
                    <div class="flex justify-between">
                        <div class="h-4 w-1/3 bg-gray-200 rounded checkout-loader"></div>
                        <div class="h-4 w-1/4 bg-gray-200 rounded checkout-loader"></div>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-xl p-4 shadow-sm">
                <div class="h-6 w-1/2 bg-gray-200 rounded checkout-loader mb-3"></div>
                <div class="space-y-2">
                    <div class="h-12 w-full bg-gray-200 rounded-lg checkout-loader"></div>
                    <div class="h-12 w-full bg-gray-200 rounded-lg checkout-loader"></div>
                    <div class="h-12 w-full bg-gray-200 rounded-lg checkout-loader"></div>
                </div>
            </div>
            <div class="h-10 w-full bg-gray-200 rounded-full checkout-loader"></div>
        </div>
        <div id="checkout-content">
            <div class="bg-white rounded-xl p-4 shadow-sm mb-6">
                <div class="flex items-center justify-between mb-3">
                    <h2 class="font-bold flex items-center">
                        <i data-feather="map-pin" class="w-4 h-4 mr-2 text-orange-500" aria-hidden="true"></i>
                        Delivery Address
                    </h2>
                    <button class="text-sm text-orange-500 ripple" id="change-address" aria-label="Change delivery address">Change</button>
                </div>
                <div class="bg-gray-50 p-3 rounded-lg" id="address-container">
                    <p class="text-sm text-gray-600">No address selected. <a href="/saved-addresses.html" class="text-orange-500">Add one</a>.</p>
                </div>
            </div>
            <div class="bg-white rounded-xl p-4 shadow-sm mb-6 md:max-w-md md:mx-auto" id="order-summary">
                <h2 class="font-bold mb-3">Order Summary</h2>
                <div class="space-y-3 mb-3" id="order-items"></div>
                <div class="border-t border-gray-200 pt-3 mb-3" id="summary-details">
                    <div class="flex justify-between">
                        <span class="text-gray-600">Subtotal</span>
                        <span class="font-medium" id="subtotal">₦0</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Delivery Fee</span>
                        <span class="font-medium" id="delivery-fee">₦0</span>
                    </div>
                </div>
                <div class="border-t border-gray-200 pt-3">
                    <div class="flex justify-between">
                        <span class="font-bold">Total</span>
                        <span class="font-bold text-orange-500" id="total">₦0</span>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-xl p-4 shadow-sm mb-6">
                <h2 class="font-bold mb-3">Payment Method</h2>
                <div class="space-y-3" id="payment-methods"></div>
            </div>
            <div class="bg-white rounded-xl p-4 shadow-sm mb-6">
                <h2 class="font-bold mb-3">Order Notes (Optional)</h2>
                <textarea class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-1 focus:ring-orange-500 focus:border-transparent" 
                          rows="3" placeholder="Any special instructions for delivery..." id="order-notes" aria-label="Order notes"></textarea>
            </div>
            <button class="w-full py-3 bg-orange-500 text-white rounded-full font-bold ripple mb-6" id="place-order" aria-label="Place order">
                Place Order
            </button>
        </div>
    </main>
    <nav class="bottom-nav fixed bottom-0 left-0 right-0 bg-white shadow-lg border-t border-gray-200 z-10" role="navigation" aria-label="Main navigation">
        <div class="flex justify-around items-center h-16">
            <a href="index.html" class="flex flex-col items-center text-gray-500">
                <i data-feather="home" class="w-6 h-6" aria-hidden="true"></i>
                <span class="text-xs mt-1">Home</span>
            </a>
            <a href="categories.html" class="flex flex-col items-center text-gray-500">
                <i data-feather="grid" class="w-6 h-6" aria-hidden="true"></i>
                <span class="text-xs mt-1">Categories</span>
            </a>
            <a href="cart.html" class="flex flex-col items-center text-gray-500">
                <div class="relative">
                    <i data-feather="shopping-cart" class="w-6 h-6" aria-hidden="true"></i>
                    <span id="cart-count" class="absolute -top-1 -right-1 bg-orange-500 text-white text-xs font-bold rounded-full h-4 w-4 flex items-center justify-center" aria-label="Cart items count">0</span>
                </div>
                <span class="text-xs mt-1">Cart</span>
            </a>
            <a href="orders.html" class="flex flex-col items-center text-gray-500">
                <i data-feather="package" class="w-6 h-6" aria-hidden="true"></i>
                <span class="text-xs mt-1">Orders</span>
            </a>
            <a href="profile.html" class="flex flex-col items-center text-gray-500">
                <i data-feather="user" class="w-6 h-6" aria-hidden="true"></i>
                <span class="text-xs mt-1">Profile</span>
            </a>
        </div>
    </nav>
    <div id="payment-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden" role="dialog" aria-modal="true" style="--modal-display: none;">
        <div class="bg-white p-6 rounded-lg max-w-sm w-full">
            <h2 class="font-bold mb-4">Complete Payment via Bank Transfer</h2>
            <p>Please transfer the amount to:</p>
            <p><strong>Bank:</strong> <span id="modal-bank"></span></p>
            <p><strong>Account Name:</strong> <span id="modal-account-name"></span></p>
            <p><strong>Account Number:</strong> <span id="modal-account-number"></span></p>
            <p><strong>Amount:</strong> ₦<span id="modal-total"></span></p>
            <p><strong>Time left:</strong> <span id="countdown">2:00</span></p>
            <button id="sent-button" class="mt-4 py-2 bg-orange-500 text-white rounded-full w-full ripple">I have transferred the payment</button>
            <button id="close-payment-modal" class="mt-2 py-2 bg-gray-300 text-gray-700 rounded-full w-full ripple">Cancel</button>
        </div>
    </div>
    <div id="proof-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden" role="dialog" aria-modal="true" style="--modal-display: none;">
        <div class="bg-white p-6 rounded-lg max-w-sm w-full">
            <h2 class="font-bold mb-4">Upload Proof of Payment</h2>
            <input type="file" id="proof-file" accept="image/*,application/pdf" class="mb-4 w-full border border-gray-300 rounded-lg p-2 focus:outline-none focus:ring-1 focus:ring-orange-500">
            <button id="upload-button" class="py-2 bg-orange-500 text-white rounded-full w-full ripple">Submit Proof</button>
            <button id="close-proof-modal" class="mt-2 py-2 bg-gray-300 text-gray-700 rounded-full w-full ripple">Cancel</button>
        </div>
    </div>
    <script>
        feather.replace();
        const API_BASE_URL = 'https://pulse-parcel.onrender.com/api';
        const DELIVERY_FEE = 5000;
        const FALLBACK_BANK_DETAILS = {
            bank: 'Example Bank',
            accountName: ' PULSE PARCLE ',
            accountNumber: '0123456789'
        };

        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type} shadow-lg`;
            toast.textContent = message;
            toast.setAttribute('role', 'alert');
            document.body.appendChild(toast);
            setTimeout(() => { toast.classList.add('show'); }, 100);
            setTimeout(() => { toast.classList.remove('show'); setTimeout(() => { toast.remove(); }, 300); }, 2000);
        }

        function checkAuth() {
            const token = localStorage.getItem('token');
            if (!token) {
                showToast('Please log in to proceed with checkout.', 'error');
                setTimeout(() => { window.location.href = '/login.html?redirect=checkout'; }, 2000);
                return false;
            }
            return true;
        }

        function setupAuthUI() {
            const authLinks = document.getElementById('auth-links');
            if (!authLinks) {
                console.error('Auth links element not found');
                showToast('UI error: Auth links missing.', 'error');
                return;
            }
            authLinks.innerHTML = '';
        }

        function showShimmer() {
            const checkoutLoader = document.getElementById('checkout-loader');
            const checkoutContent = document.getElementById('checkout-content');
            if (!checkoutLoader || !checkoutContent) {
                console.error('Loader elements not found:', {
                    checkoutLoader: !!checkoutLoader,
                    checkoutContent: !!checkoutContent
                });
                showToast('UI error: Checkout loader missing.', 'error');
                const main = document.querySelector('main');
                if (main) {
                    main.innerHTML = '<p class="text-center text-gray-500">Loading checkout...</p>';
                }
                return;
            }
            checkoutLoader.classList.remove('hidden');
            checkoutContent.classList.add('hidden');
        }

        function hideShimmer() {
            const checkoutLoader = document.getElementById('checkout-loader');
            const checkoutContent = document.getElementById('checkout-content');
            if (!checkoutLoader || !checkoutContent) {
                console.error('Loader elements not found:', {
                    checkoutLoader: !!checkoutLoader,
                    checkoutContent: !!checkoutContent
                });
                showToast('UI error: Checkout content missing.', 'error');
                return;
            }
            checkoutLoader.classList.add('hidden');
            checkoutContent.classList.remove('hidden');
        }

        async function fetchBankDetails() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_BASE_URL}/bank-details`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                console.log('Bank details response status:', response.status);
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    console.error('Bank details fetch error:', errorData);
                    throw new Error(errorData.message || `Failed to fetch bank details: ${response.status}`);
                }
                const bankDetails = await response.json();
                console.log('Bank details received:', bankDetails);
                return bankDetails;
            } catch (error) {
                console.error('Error fetching bank details:', error.message);
                showToast('Failed to load bank details. Using fallback details.', 'error');
                return FALLBACK_BANK_DETAILS;
            }
        }

        async function fetchCheckoutData(retryCount = 0, maxRetries = 2) {
            console.log('Fetching checkout data, checking DOM elements:', {
                checkoutLoader: !!document.getElementById('checkout-loader'),
                checkoutContent: !!document.getElementById('checkout-content')
            });
            showShimmer();
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_BASE_URL}/checkout`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json',
                        'Save-Data': navigator.connection && navigator.connection.saveData ? 'on' : 'off'
                    }
                });
                if (response.status === 401) {
                    console.warn('Unauthorized access, clearing token');
                    localStorage.removeItem('token');
                    showToast('Session expired. Please log in.', 'error');
                    setTimeout(() => { window.location.href = '/login.html?redirect=checkout'; }, 2000);
                    return;
                }
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    const errorMessage = errorData.message || response.status;
                    if (errorData.message === 'Cart is empty') {
                        hideShimmer();
                        showToast('Your cart is empty. Please add items to proceed.', 'error');
                        setTimeout(() => { window.location.href = '/cart.html'; }, 2000);
                        return;
                    }
                    throw new Error(`Failed to fetch checkout data: ${errorMessage}`);
                }
                const data = await response.json();
                console.log('Checkout data received:', JSON.stringify(data, null, 2));
                hideShimmer();
                renderCheckoutData(data);
                updateCartCount(data.cart);
                window.checkoutData = data;
            } catch (error) {
                console.error('Error fetching checkout data:', error.message);
                if (retryCount < maxRetries && !error.message.includes('401') && !error.message.includes('Cart is empty')) {
                    console.log(`Retrying fetchCheckoutData (${retryCount + 1}/${maxRetries})...`);
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    return fetchCheckoutData(retryCount + 1, maxRetries);
                }
                hideShimmer();
                const main = document.querySelector('main');
                if (main) {
                    main.innerHTML = '<p class="text-center text-gray-500">Failed to load checkout data. Please try again.</p>';
                }
                showToast(`Failed to load checkout data: ${error.message}`, 'error');
            }
        }

        function renderCheckoutData(data) {
            const addressContainer = document.getElementById('address-container');
            if (!addressContainer) {
                console.error('Address container not found');
                showToast('UI error: Address container missing.', 'error');
                return;
            }
            if (data.defaultAddress) {
                addressContainer.innerHTML = `
                    <p class="font-medium">${data.defaultAddress.label || 'Default Address'}</p>
                    <p class="text-sm text-gray-600">${data.defaultAddress.phone || 'N/A'}</p>
                    <p class="text-sm text-gray-600 mt-1">${data.defaultAddress.street}, ${data.defaultAddress.city}, ${data.defaultAddress.state || 'N/A'}, ${data.defaultAddress.country || 'Nigeria'}</p>
                `;
            } else {
                addressContainer.innerHTML = '<p class="text-sm text-gray-600">No address selected. <a href="/saved-addresses.html" class="text-orange-500">Add one</a>.</p>';
            }

            const orderItems = document.getElementById('order-items');
            const summaryDetails = document.getElementById('summary-details');
            const totalContainer = document.getElementById('total');
            if (!orderItems || !summaryDetails || !totalContainer) {
                console.error('Order summary elements not found:', {
                    orderItems: !!orderItems,
                    summaryDetails: !!summaryDetails,
                    totalContainer: !!totalContainer
                });
                showToast('UI error: Order summary elements missing.', 'error');
                return;
            }
            orderItems.innerHTML = data.cart && data.cart.length > 0 ? data.cart.map(item => `
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <img src="${item.product?.image ? item.product.image.replace('q_auto', navigator.connection && navigator.connection.saveData ? 'q_auto:low' : 'q_auto') : '/images/placeholder.jpg'}" 
                             alt="${item.product?.name || 'Product'}" 
                             class="w-12 h-12 object-cover rounded-lg mr-3" 
                             loading="lazy">
                        <span class="text-gray-600">${item.product?.name || 'Unknown Product'} × ${item.quantity || 0}</span>
                    </div>
                    <span class="font-medium">₦${((item.product?.price || 0) * (item.quantity || 0)).toLocaleString()}</span>
                </div>
            `).join('') : '<p class="text-gray-600">No items in cart.</p>';

            summaryDetails.innerHTML = `
                <div class="flex justify-between">
                    <span class="text-gray-600">Subtotal</span>
                    <span class="font-medium" id="subtotal">₦${data.summary?.subtotal?.toLocaleString() || '0'}</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-600">Delivery Fee</span>
                    <span class="font-medium" id="delivery-fee">₦${data.summary?.deliveryFee?.toLocaleString() || '0'}</span>
                </div>
            `;
            totalContainer.textContent = `₦${data.summary?.total?.toLocaleString() || '0'}`;

            const paymentContainer = document.getElementById('payment-methods');
            if (!paymentContainer) {
                console.error('Payment methods container not found');
                showToast('UI error: Payment methods container missing.', 'error');
                return;
            }
            paymentContainer.innerHTML = `
                <div class="payment-method border rounded-lg p-3 flex items-center cursor-pointer active" data-payment-type="bank_transfer" role="button" aria-label="Select Bank Transfer">
                    <div class="w-8 h-8 bg-orange-100 rounded-full flex items-center justify-center mr-3">
                        <i data-feather="repeat" class="text-orange-500 w-4 h-4" aria-hidden="true"></i>
                    </div>
                    <div class="flex-1">
                        <p class="font-medium">Bank Transfer</p>
                        <p class="text-xs text-gray-500">Transfer to our account and upload proof</p>
                    </div>
                    <i data-feather="check" class="text-orange-500 w-5 h-5" aria-hidden="true"></i>
                </div>
            `;
            paymentContainer.querySelectorAll('.payment-method').forEach(method => {
                method.addEventListener('click', () => {
                    paymentContainer.querySelectorAll('.payment-method').forEach(m => m.classList.remove('active'));
                    method.classList.add('active');
                });
            });

            feather.replace();
        }

        function updateCartCount(cart) {
            const count = cart && Array.isArray(cart) ? cart.reduce((sum, item) => sum + (item.quantity || 0), 0) : 0;
            const cartCount = document.getElementById('cart-count');
            if (cartCount) {
                cartCount.textContent = count;
                cartCount.setAttribute('aria-label', `Cart items count: ${count}`);
                cartCount.classList.toggle('animate-bounce', count > 0);
            }
        }

        async function placeOrder(retryCount = 0, maxRetries = 2) {
            console.log('Starting placeOrder, retry count:', retryCount);
            const paymentModal = document.getElementById('payment-modal');
            const proofModal = document.getElementById('proof-modal');
            if (!paymentModal || !proofModal) {
                console.error('Modal elements not found:', {
                    paymentModal: !!paymentModal,
                    proofModal: !!proofModal
                });
                showToast('UI error: Modal elements missing.', 'error');
                return;
            }

            try {
                if ('vibrate' in navigator) {
                    navigator.vibrate(50);
                }
                const token = localStorage.getItem('token');
                console.log('Token present:', !!token);
                if (!token) {
                    showToast('Please log in to proceed with checkout.', 'error');
                    setTimeout(() => { window.location.href = '/login.html?redirect=checkout'; }, 2000);
                    return;
                }

                const addressContainer = document.getElementById('address-container');
                console.log('Address container found:', !!addressContainer);
                if (!addressContainer.querySelector('p.font-medium')) {
                    console.log('No valid address selected');
                    showToast('Please select a delivery address.', 'error');
                    setTimeout(() => { window.location.href = '/saved-addresses.html'; }, 2000);
                    return;
                }

                const selectedPayment = document.querySelector('.payment-method.active');
                console.log('Selected payment method:', selectedPayment?.getAttribute('data-payment-type'));
                if (!selectedPayment) {
                    showToast('Please select a payment method.', 'error');
                    return;
                }
                const paymentMethod = 'Bank Transfer';
                console.log('Payment method:', paymentMethod);

                const orderNotes = document.getElementById('order-notes').value.trim();
                const cart = window.checkoutData?.cart || [];
                console.log('Cart data:', JSON.stringify(cart, null, 2));
                const items = cart.map(item => {
                    if (!item.product?._id || !item.quantity || !item.product?.price) {
                        console.error('Invalid cart item:', item);
                        throw new Error('Invalid cart item: missing product ID, quantity, or price');
                    }
                    // Optimize images for Save-Data
                    if (navigator.connection && navigator.connection.saveData && item.product.image) {
                        item.product.image = item.product.image.replace('q_auto', 'q_auto:low');
                        console.log('Optimized image for Save-Data:', item.product.image);
                    }
                    return {
                        product: item.product._id,
                        quantity: item.quantity,
                        price: item.product.price
                    };
                });

                if (!items.length) {
                    console.log('Cart is empty');
                    showToast('Your cart is empty. Please add items to proceed.', 'error');
                    setTimeout(() => { window.location.href = '/cart.html'; }, 2000);
                    return;
                }

                console.log('Fetching addresses...');
                const addressResponse = await fetch(`${API_BASE_URL}/addresses`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json',
                        'Save-Data': navigator.connection && navigator.connection.saveData ? 'on' : 'off'
                    }
                });
                console.log('Address response status:', addressResponse.status);
                if (addressResponse.status === 401) {
                    console.warn('Unauthorized access, clearing token');
                    localStorage.removeItem('token');
                    showToast('Session expired. Please log in.', 'error');
                    setTimeout(() => { window.location.href = '/login.html?redirect=checkout'; }, 2000);
                    return;
                }
                if (!addressResponse.ok) {
                    const errorData = await addressResponse.json().catch(() => ({}));
                    throw new Error(`Failed to fetch addresses: ${errorData.message || addressResponse.status}`);
                }
                const addresses = await addressResponse.json();
                console.log('Addresses fetched:', JSON.stringify(addresses, null, 2));
                const defaultAddress = addresses.find(addr => addr.isDefault);
                console.log('Default address:', defaultAddress);
                if (!defaultAddress) {
                    console.log('No default address found');
                    showToast('Please set a default delivery address.', 'error');
                    setTimeout(() => { window.location.href = '/saved-addresses.html'; }, 2000);
                    return;
                }
                if (!defaultAddress.state || !defaultAddress.country) {
                    console.log('Invalid address (missing state or country)');
                    showToast('Selected address is invalid (missing state or country). Please update your address.', 'error');
                    setTimeout(() => { window.location.href = '/saved-addresses.html'; }, 2000);
                    return;
                }

                console.log('Fetching bank details...');
                const bankDetails = await fetchBankDetails();
                console.log('Bank details fetched:', bankDetails);

                const requestBody = {
                    items,
                    deliveryAddress: defaultAddress._id,
                    paymentMethod,
                    orderNotes,
                    paymentStatus: 'pending'
                };
                console.log('Sending order request:', JSON.stringify(requestBody, null, 2));

                const orderResponse = await fetch(`${API_BASE_URL}/orders`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`,
                        'Save-Data': navigator.connection && navigator.connection.saveData ? 'on' : 'off'
                    },
                    body: JSON.stringify(requestBody)
                });
                console.log('Order response status:', orderResponse.status);
                if (!orderResponse.ok) {
                    const errorData = await orderResponse.json().catch(() => ({}));
                    console.error('Order request failed:', JSON.stringify(errorData, null, 2));
                    if (errorData.message === 'Delivery address not found') {
                        showToast('Invalid delivery address. Please select a valid address.', 'error');
                        setTimeout(() => { window.location.href = '/saved-addresses.html'; }, 2000);
                        return;
                    }
                    if (errorData.message === 'Invalid payment method') {
                        showToast('Invalid payment method selected. Please try again.', 'error');
                        return;
                    }
                    if (errorData.message.includes('Items array is required')) {
                        showToast('Your cart is empty or invalid. Please add items to proceed.', 'error');
                        setTimeout(() => { window.location.href = '/cart.html'; }, 2000);
                        return;
                    }
                    if (errorData.message.includes('paymentStatus')) {
                        showToast('Invalid payment status. Please contact support.', 'error');
                        return;
                    }
                    if (retryCount < maxRetries) {
                        console.log(`Retrying placeOrder (${retryCount + 1}/${maxRetries})...`);
                        await new Promise(resolve => setTimeout(resolve, 1000));
                        return placeOrder(retryCount + 1, maxRetries);
                    }
                    throw new Error(`Failed to place order: ${errorData.message || orderResponse.status}`);
                }

                const order = await orderResponse.json();
                console.log('Order placed successfully:', JSON.stringify(order, null, 2));
                window.currentOrderId = order._id;
                window.currentOrderNumber = order.orderNumber;

                const modalBank = document.getElementById('modal-bank');
                const modalAccountName = document.getElementById('modal-account-name');
                const modalAccountNumber = document.getElementById('modal-account-number');
                const modalTotal = document.getElementById('modal-total');
                const countdownEl = document.getElementById('countdown');
                if (!modalBank || !modalAccountName || !modalAccountNumber || !modalTotal || !countdownEl) {
                    console.error('Payment modal elements not found:', {
                        modalBank: !!modalBank,
                        modalAccountName: !!modalAccountName,
                        modalAccountNumber: !!modalAccountNumber,
                        modalTotal: !!modalTotal,
                        countdownEl: !!countdownEl
                    });
                    showToast('UI error: Payment modal elements missing.', 'error');
                    return;
                }

                modalBank.textContent = bankDetails.bank || 'N/A';
                modalAccountName.textContent = bankDetails.accountName || 'N/A';
                modalAccountNumber.textContent = bankDetails.accountNumber || 'N/A';
                modalTotal.textContent = order.total.toLocaleString();
                paymentModal.classList.remove('hidden');
                paymentModal.style.setProperty('--modal-display', 'block');
                console.log('Payment modal element:', paymentModal);
                console.log('Removing hidden class from payment modal...');
                console.log('Payment modal should be visible');

                let timeLeft = 120;
                console.log('Starting countdown:', timeLeft);
                window.countdownInterval = setInterval(async () => {
                    timeLeft--;
                    console.log('Countdown:', timeLeft);
                    const minutes = Math.floor(timeLeft / 60);
                    const seconds = timeLeft % 60;
                    countdownEl.textContent = `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
                    if (timeLeft <= 0) {
                        console.log('Countdown expired');
                        clearInterval(window.countdownInterval);
                        paymentModal.classList.add('hidden');
                        paymentModal.style.setProperty('--modal-display', 'none');
                        showToast('Payment time expired. Please try again.', 'error');
                        try {
                            const cancelResponse = await fetch(`${API_BASE_URL}/orders/${order._id}/cancel`, {
                                method: 'POST',
                                headers: {
                                    'Authorization': `Bearer ${token}`,
                                    'Content-Type': 'application/json'
                                }
                            });
                            if (!cancelResponse.ok) {
                                console.error('Failed to cancel order:', cancelResponse.status);
                            }
                        } catch (error) {
                            console.error('Error cancelling order:', error.message);
                        }
                        setTimeout(() => { window.location.href = '/cart.html'; }, 2000);
                    }
                }, 1000);

            } catch (error) {
                console.error('Error in placeOrder:', error.message);
                if (retryCount < maxRetries) {
                    console.log(`Retrying placeOrder (${retryCount + 1}/${maxRetries})...`);
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    return placeOrder(retryCount + 1, maxRetries);
                }
                paymentModal.classList.add('hidden');
                paymentModal.style.setProperty('--modal-display', 'none');
                showToast(`Failed to place order: ${error.message}. Please try again.`, 'error');
            }
        }

        async function uploadProofOfPayment() {
            const proofModal = document.getElementById('proof-modal');
            const fileInput = document.getElementById('proof-file');
            if (!proofModal || !fileInput) {
                console.error('Proof modal elements not found:', {
                    proofModal: !!proofModal,
                    fileInput: !!fileInput
                });
                showToast('UI error: Proof modal elements missing.', 'error');
                return;
            }

            const file = fileInput.files[0];
            if (!file) {
                showToast('Please select a file.', 'error');
                return;
            }

            const formData = new FormData();
            formData.append('proof', file);
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_BASE_URL}/orders/${window.currentOrderId}/upload-proof`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    body: formData
                });
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.message || 'Failed to upload proof');
                }
                proofModal.classList.add('hidden');
                proofModal.style.setProperty('--modal-display', 'none');
                showToast('Proof uploaded successfully! Order is now pending verification.', 'success');
                setTimeout(() => { window.location.href = '/orders.html'; }, 2000);
            } catch (error) {
                console.error('Error uploading proof:', error.message);
                showToast(`Failed to upload proof: ${error.message}. Please try again.`, 'error');
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            if (checkAuth()) {
                setupAuthUI();
                fetchCheckoutData();

                document.getElementById('place-order').addEventListener('click', placeOrder);
                document.getElementById('change-address').addEventListener('click', () => {
                    window.location.href = '/saved-addresses.html';
                });
                document.getElementById('sent-button').addEventListener('click', () => {
                    const paymentModal = document.getElementById('payment-modal');
                    paymentModal.classList.add('hidden');
                    paymentModal.style.setProperty('--modal-display', 'none');
                    clearInterval(window.countdownInterval);
                    document.getElementById('proof-modal').classList.remove('hidden');
                    document.getElementById('proof-modal').style.setProperty('--modal-display', 'block');
                    console.log('Opened proof modal');
                });
                document.getElementById('upload-button').addEventListener('click', uploadProofOfPayment);
                document.getElementById('close-payment-modal')?.addEventListener('click', () => {
                    const paymentModal = document.getElementById('payment-modal');
                    paymentModal.classList.add('hidden');
                    paymentModal.style.setProperty('--modal-display', 'none');
                    clearInterval(window.countdownInterval);
                    console.log('Payment modal closed manually');
                    showToast('Order placement cancelled.', 'error');
                    setTimeout(() => { window.location.href = '/cart.html'; }, 2000);
                });
                document.getElementById('close-proof-modal')?.addEventListener('click', () => {
                    const proofModal = document.getElementById('proof-modal');
                    proofModal.classList.add('hidden');
                    proofModal.style.setProperty('--modal-display', 'none');
                    console.log('Proof modal closed manually');
                    showToast('Proof upload cancelled.', 'error');
                    setTimeout(() => { window.location.href = '/cart.html'; }, 2000);
                });
            }
        });
    </script>
</body>
</html>