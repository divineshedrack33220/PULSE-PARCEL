<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout - PULSE PARCLE</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-orange: #FF7A2F;
            --secondary-brown: #3E2723;
            --accent-cream: #FFF6ED;
            --neutral-gray: #555555;
            --light-gray: #EDEDED;
            --alert-red: #EF4444;
        }
        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--accent-cream);
            color: var(--secondary-brown);
        }
        .back-button {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 42px;
            height: 42px;
            background: rgba(0,0,0,0.06);
            border-radius: 50%;
            transition: all 0.2s ease;
        }
        .back-button:hover { background: rgba(0,0,0,0.12); }

        .payment-method {
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        .payment-method.active {
            border-color: var(--primary-orange);
            background-color: rgba(255, 122, 47, 0.05);
        }
        .ripple {
            position: relative;
            overflow: hidden;
        }
        .ripple:after {
            content: "";
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            pointer-events: none;
            background-image: radial-gradient(circle, #fff 10%, transparent 10.01%);
            background-repeat: no-repeat;
            background-position: 50%;
            transform: scale(10,10);
            opacity: 0;
            transition: transform .5s, opacity 1s;
        }
        .ripple:active:after {
            transform: scale(0,0);
            opacity: .3;
            transition: 0s;
        }
        .toast {
            position: fixed;
            top: 1rem;
            right: 1rem;
            padding: 0.75rem 1.5rem;
            border-radius: 50px;
            z-index: 100;
            opacity: 0;
            transform: translateY(-20px);
            transition: all 0.3s ease;
            font-size: 0.875rem;
            font-weight: 500;
        }
        .toast.show { opacity: 1; transform: translateY(0); }
        .toast.success { background-color: #10B981; color: white; }
        .toast.error { background-color: var(--alert-red); color: white; }

        .checkout-loader {
            animation: shimmer 1.5s infinite linear;
            background: linear-gradient(to right, #f6f6f6 0%, #edeef1 20%, #f6f6f6 40%, #f6f6f6 100%);
            background-size: 200% 100%;
        }
        @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }

        #payment-modal, #proof-modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            z-index: 100;
            align-items: center;
            justify-content: center;
        }
        #payment-modal.show, #proof-modal.show { display: flex; }
    </style>
</head>
<body class="min-h-screen">

    <!-- Clean Header: Back + Centered Title -->
    <header class="bg-white shadow-sm sticky top-0 z-50">
        <div class="container mx-auto px-4 py-4 flex items-center justify-between relative">
            <button onclick="history.back()" class="back-button ripple" aria-label="Go back">
                <i data-feather="arrow-left" class="w-6 h-6 text-neutral-gray"></i>
            </button>
            <h1 class="absolute left-1/2 transform -translate-x-1/2 text-lg font-bold text-neutral-gray">Checkout</h1>
            <div class="w-10 h-10"></div>
        </div>
    </header>

    <main class="container mx-auto px-4 py-6 lg:max-w-4xl">
        <div id="checkout-loader" class="space-y-6 hidden">
            <div class="bg-white rounded-xl p-6 shadow-sm"><div class="h-6 w-40 bg-gray-200 rounded checkout-loader mb-4"></div><div class="bg-gray-50 p-4 rounded-lg"><div class="h-4 w-64 bg-gray-200 rounded checkout-loader mb-2"></div><div class="h-4 w-48 bg-gray-200 rounded checkout-loader"></div></div></div>
            <div class="bg-white rounded-xl p-6 shadow-sm space-y-4"><div class="h-6 w-32 bg-gray-200 rounded checkout-loader"></div><div class="space-y-3"><div class="flex justify-between"><div class="h-4 w-32 bg-gray-200 rounded checkout-loader"></div><div class="h-4 w-24 bg-gray-200 rounded checkout-loader"></div></div><div class="flex justify-between"><div class="h-4 w-32 bg-gray-200 rounded checkout-loader"></div><div class="h-4 w-24 bg-gray-200 rounded checkout-loader"></div></div></div></div>
            <div class="h-14 w-full bg-gray-200 rounded-full checkout-loader"></div>
        </div>

        <div id="checkout-content" class="space-y-6">
            <div class="bg-white rounded-xl p-6 shadow-sm">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="font-bold text-lg flex items-center"><i data-feather="map-pin" class="w-5 h-5 mr-2 text-orange-500"></i>Delivery Address</h2>
                    <button class="text-orange-500 text-sm font-medium ripple" id="change-address">Change</button>
                </div>
                <div class="bg-gray-50 p-4 rounded-lg" id="address-container">
                    <p class="text-sm text-gray-600">No address selected. <a href="/saved-addresses.html" class="text-orange-500 font-medium">Add one</a>.</p>
                </div>
            </div>

            <div class="bg-white rounded-xl p-6 shadow-sm">
                <h2 class="font-bold text-lg mb-4">Order Summary</h2>
                <div class="space-y-4 mb-6" id="order-items"></div>
                <div class="border-t pt-4" id="summary-details">
                    <div class="flex justify-between text-gray-600 mb-2"><span>Subtotal</span><span id="subtotal" class="font-medium">₦0</span></div>
                    <div class="flex justify-between text-gray-600 mb-2"><span>Delivery Fee</span><span id="delivery-fee" class="font-medium">₦0</span></div>
                </div>
                <div class="border-t pt-4"><div class="flex justify-between text-lg font-bold"><span>Total</span><span class="text-orange-500" id="total">₦0</span></div></div>
            </div>

            <div class="bg-white rounded-xl p-6 shadow-sm">
                <h2 class="font-bold text-lg mb-4">Payment Method</h2>
                <div class="space-y-3" id="payment-methods"></div>
            </div>

            <div class="bg-white rounded-xl p-6 shadow-sm">
                <h2 class="font-bold text-lg mb-4">Order Notes (Optional)</h2>
                <textarea class="w-full p-4 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500 resize-none" rows="4" placeholder="Any special instructions..." id="order-notes"></textarea>
            </div>

            <button class="w-full py-4 bg-orange-500 text-white rounded-full font-bold text-lg ripple shadow-lg hover:bg-orange-600 transition" id="place-order">Place Order</button>
        </div>
    </main>

    <!-- Payment Modal -->
    <div id="payment-modal" class="hidden">
        <div class="bg-white p-8 rounded-2xl max-w-sm w-full mx-4 shadow-2xl">
            <h2 class="font-bold text-xl mb-6 text-center">Complete Payment</h2>
            <div class="space-y-3 text-sm">
                <p><strong>Bank:</strong> <span id="modal-bank"></span></p>
                <p><strong>Account Name:</strong> <span id="modal-account-name"></span></p>
                <p><strong>Account Number:</strong> <span id="modal-account-number"></span></p>
                <p class="text-lg font-bold mt-4"><strong>Amount:</strong> ₦<span id="modal-total"></span></p>
                <p class="text-orange-600 font-medium">Time left: <span id="countdown">2:00</span></p>
            </div>
            <button id="sent-button" class="mt-6 w-full py-3 bg-orange-500 text-white rounded-full font-bold ripple hover:bg-orange-600">I have transferred the payment</button>
            <button id="close-payment-modal" class="mt-3 w-full py-3 bg-gray-200 text-gray-700 rounded-full font-medium ripple">Cancel</button>
        </div>
    </div>

    <!-- Proof Modal -->
    <div id="proof-modal" class="hidden">
        <div class="bg-white p-8 rounded-2xl max-w-sm w-full mx-4 shadow-2xl">
            <h2 class="font-bold text-xl mb-6 text-center">Upload Proof of Payment</h2>
            <input type="file" id="proof-file" accept="image/*,application/pdf" class="w-full p-4 border-2 border-dashed border-gray-300 rounded-lg text-center cursor-pointer hover:border-orange-500 transition">
            <button id="upload-button" class="mt-6 w-full py-3 bg-orange-500 text-white rounded-full font-bold ripple hover:bg-orange-600">Submit Proof</button>
            <button id="close-proof-modal" class="mt-3 w-full py-3 bg-gray-200 text-gray-700 rounded-full font-medium ripple">Cancel</button>
        </div>
    </div>

    Floating Chat Button
    <div class="fixed bottom-24 right-4 z-20">
        <button class="bg-green-500 text-white w-14 h-14 rounded-full shadow-2xl ripple flex items-center justify-center hover:bg-green-600" onclick="window.location.href='/chat.html'">
            <i data-feather="message-circle" class="w-7 h-7"></i>
        </button>
    </div>

    <script>
        feather.replace();
        const API_BASE_URL = 'https://pulse-parcel.onrender.com/api';
        const FALLBACK_BANK_DETAILS = { bank: 'UNION BANK NIGERIA ', accountName: ' PULSE PARCEL LIMITED', accountNumber: '0236868956' };

        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type} shadow-lg`;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.classList.add('show'), 100);
            setTimeout(() => { toast.classList.remove('show'); setTimeout(() => toast.remove(), 300); }, 3000);
        }

        function checkAuth() {
            const token = localStorage.getItem('token');
            if (!token) {
                showToast('Please log in to proceed with checkout.', 'error');
                setTimeout(() => { window.location.href = '/login.html?redirect=checkout'; }, 2000);
                return false;
            }
            return true;
        }

        function showShimmer() {
            document.getElementById('checkout-loader')?.classList.remove('hidden');
            document.getElementById('checkout-content')?.classList.add('hidden');
        }

        function hideShimmer() {
            document.getElementById('checkout-loader')?.classList.add('hidden');
            document.getElementById('checkout-content')?.classList.remove('hidden');
        }

        async function fetchBankDetails() {
            try {
                const token = localStorage.getItem('token');
                const res = await fetch(`${API_BASE_URL}/bank-details`, { headers: { 'Authorization': `Bearer ${token}` } });
                if (!res.ok) throw new Error();
                return await res.json();
            } catch {
                showToast('Using fallback bank details.', 'error');
                return FALLBACK_BANK_DETAILS;
            }
        }

        async function fetchCheckoutData() {
            showShimmer();
            try {
                const token = localStorage.getItem('token');
                const res = await fetch(`${API_BASE_URL}/checkout`, { headers: { 'Authorization': `Bearer ${token}` } });
                if (!res.ok) { const err = await res.json(); throw new Error(err.message || 'Failed'); }
                const data = await res.json();
                hideShimmer();
                renderCheckoutData(data);
                updateCartCount(data.cart);
                window.checkoutData = data;
            } catch (err) {
                hideShimmer();
                showToast('Failed to load checkout: ' + err.message, 'error');
            }
        }

        function renderCheckoutData(data) {
            // Your full original renderCheckoutData function here (unchanged)
            const addressContainer = document.getElementById('address-container');
            if (data.defaultAddress) {
                addressContainer.innerHTML = `<p class="font-medium">${data.defaultAddress.label || 'Default'}</p><p class="text-sm text-gray-600">${data.defaultAddress.phone}</p><p class="text-sm text-gray-600 mt-1">${data.defaultAddress.street}, ${data.defaultAddress.city}, ${data.defaultAddress.state || 'N/A'}</p>`;
            } else {
                addressContainer.innerHTML = '<p class="text-sm text-gray-600">No address selected. <a href="/saved-addresses.html" class="text-orange-500">Add one</a>.</p>';
            }

            document.getElementById('order-items').innerHTML = data.cart?.length ? data.cart.map(i => `
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <img src="${i.product.image || '/images/placeholder.jpg'}" class="w-12 h-12 rounded-lg mr-3 object-cover" loading="lazy">
                        <span class="text-gray-600">${i.product.name} × ${i.quantity}</span>
                    </div>
                    <span class="font-medium">₦${(i.product.price * i.quantity).toLocaleString()}</span>
                </div>
            `).join('') : '<p class="text-gray-600">No items</p>';

            document.getElementById('subtotal').textContent = `₦${data.summary.subtotal.toLocaleString()}`;
            document.getElementById('delivery-fee').textContent = `₦${data.summary.deliveryFee.toLocaleString()}`;
            document.getElementById('total').textContent = `₦${data.summary.total.toLocaleString()}`;

            document.getElementById('payment-methods').innerHTML = `
                <div class="payment-method border rounded-lg p-4 flex items-center cursor-pointer active" data-payment-type="bank_transfer">
                    <div class="w-10 h-10 bg-orange-100 rounded-full flex items-center justify-center mr-4"><i data-feather="repeat" class="w-5 h-5 text-orange-500"></i></div>
                    <div><p class="font-medium">Bank Transfer</p><p class="text-xs text-gray-500">Transfer & upload proof</p></div>
                    <i data-feather="check" class="ml-auto text-orange-500 w-6 h-6"></i>
                </div>
            `;
            document.querySelectorAll('.payment-method').forEach(m => m.onclick = () => document.querySelectorAll('.payment-method').forEach(x => x.classList.toggle('active', x === m)));
            feather.replace();
        }

        function updateCartCount(cart) {
            const count = cart?.reduce((s, i) => s + i.quantity, 0) || 0;
            const el = document.getElementById('cart-count');
            if (el) el.textContent = count;
        }

        // Full original placeOrder & uploadProofOfPayment preserved below
        async function placeOrder(retryCount = 0, maxRetries = 2) {
            const paymentModal = document.getElementById('payment-modal');
            const proofModal = document.getElementById('proof-modal');

            try {
                const token = localStorage.getItem('token');
                if (!token) return showToast('Login required', 'error');

                if (!document.querySelector('#address-container p.font-medium')) {
                    showToast('Please select delivery address', 'error');
                    setTimeout(() => location.href = '/saved-addresses.html', 2000);
                    return;
                }

                const cart = window.checkoutData?.cart || [];
                if (!cart.length) return showToast('Cart is empty', 'error');

                const items = cart.map(i => ({ product: i.product._id, quantity: i.quantity, price: i.product.price }));
                const addresses = await (await fetch(`${API_BASE_URL}/addresses`, { headers: { Authorization: `Bearer ${token}` } })).json();
                const defaultAddress = addresses.find(a => a.isDefault);
                if (!defaultAddress) return showToast('Set default address', 'error');

                const bankDetails = await fetchBankDetails();

                const orderRes = await fetch(`${API_BASE_URL}/orders`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({
                        items,
                        deliveryAddress: defaultAddress._id,
                        paymentMethod: 'Bank Transfer',
                        orderNotes: document.getElementById('order-notes').value.trim(),
                        paymentStatus: 'pending'
                    })
                });

                if (!orderRes.ok) throw new Error((await orderRes.json()).message || 'Order failed');

                const order = await orderRes.json();
                window.currentOrderId = order._id;

                document.getElementById('modal-bank').textContent = bankDetails.bank;
                document.getElementById('modal-account-name').textContent = bankDetails.accountName;
                document.getElementById('modal-account-number').textContent = bankDetails.accountNumber;
                document.getElementById('modal-total').textContent = order.total.toLocaleString();

                paymentModal.classList.remove('hidden');
                paymentModal.classList.add('show');

                let timeLeft = 120;
                window.countdownInterval = setInterval(() => {
                    timeLeft--;
                    const m = Math.floor(timeLeft / 60), s = timeLeft % 60;
                    document.getElementById('countdown').textContent = `${m}:${s < 10 ? '0' : ''}${s}`;
                    if (timeLeft <= 0) {
                        clearInterval(window.countdownInterval);
                        paymentModal.classList.add('hidden');
                        showToast('Time expired', 'error');
                        setTimeout(() => location.href = '/cart.html', 2000);
                    }
                }, 1000);

            } catch (err) {
                if (retryCount < maxRetries) return setTimeout(() => placeOrder(retryCount + 1), 1000);
                showToast('Order failed: ' + err.message, 'error');
            }
        }

        async function uploadProofOfPayment() {
            const file = document.getElementById('proof-file').files[0];
            if (!file) return showToast('Select a file', 'error');

            const form = new FormData();
            form.append('proof', file);

            try {
                const token = localStorage.getItem('token');
                const res = await fetch(`${API_BASE_URL}/orders/${window.currentOrderId}/upload-proof`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` },
                    body: form
                });
                if (!res.ok) throw new Error('Upload failed');
                document.getElementById('proof-modal').classList.add('hidden');
                showToast('Proof uploaded! Awaiting verification.', 'success');
                setTimeout(() => location.href = '/orders.html', 2000);
            } catch {
                showToast('Upload failed. Try again.', 'error');
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            if (checkAuth()) {
                fetchCheckoutData();

                document.getElementById('place-order')?.addEventListener('click', placeOrder);
                document.getElementById('change-address')?.addEventListener('click', () => location.href = '/saved-addresses.html');
                document.getElementById('sent-button')?.addEventListener('click', () => {
                    document.getElementById('payment-modal').classList.add('hidden');
                    clearInterval(window.countdownInterval);
                    document.getElementById('proof-modal').classList.remove('hidden');
                    document.getElementById('proof-modal').classList.add('show');
                });
                document.getElementById('upload-button')?.addEventListener('click', uploadProofOfPayment);
                document.getElementById('close-payment-modal')?.addEventListener('click', () => {
                    document.getElementById('payment-modal').classList.add('hidden');
                    clearInterval(window.countdownInterval);
                    showToast('Order cancelled', 'error');
                    setTimeout(() => location.href = '/cart.html', 2000);
                });
                document.getElementById('close-proof-modal')?.addEventListener('click', () => {
                    document.getElementById('proof-modal').classList.add('hidden');
                    showToast('Upload cancelled', 'error');
                    setTimeout(() => location.href = '/cart.html', 2000);
                });
            }
        });
    </script>
</body>
</html>