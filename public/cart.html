<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cart - PULSE PARCLE</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-orange: #FF7A2F;
            --secondary-brown: #3E2723;
            --accent-cream: #FFF6ED;
            --neutral-gray: #555555;
            --light-gray: #EDEDED;
        }
        
        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--accent-cream);
            color: var(--secondary-brown);
        }
        
        .cart-item {
            transition: all 0.3s ease;
        }
        
        .cart-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .ripple {
            position: relative;
            overflow: hidden;
        }
        
        .ripple:after {
            content: "";
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            pointer-events: none;
            background-image: radial-gradient(circle, #fff 10%, transparent 10.01%);
            background-repeat: no-repeat;
            background-position: 50%;
            transform: scale(10,10);
            opacity: 0;
            transition: transform .5s, opacity 1s;
        }
        
        .ripple:active:after {
            transform: scale(0,0);
            opacity: .3;
            transition: 0s;
        }

        .back-button {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 42px;
            height: 42px;
            background: rgba(0,0,0,0.06);
            border-radius: 50%;
            transition: all 0.2s ease;
        }

        .back-button:hover {
            background: rgba(0,0,0,0.12);
        }

        .cart-loader {
            animation: shimmer 1.5s infinite linear;
            background: linear-gradient(to right, #f6f6f6 0%, #edeef1 20%, #f6f6f6 40%, #f6f6f6 100%);
            background-size: 200% 100%;
        }

        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
    </style>
</head>
<body class="min-h-screen">

    <!-- Top Header: Back Button (Left) + Title (Center) -->
    <header class="bg-white shadow-sm sticky top-0 z-50">
        <div class="container mx-auto px-4 py-4 flex items-center justify-between relative">
            <!-- Back Button -->
            <button onclick="history.back()" class="back-button ripple" aria-label="Go back">
                <i data-feather="arrow-left" class="w-6 h-6 text-neutral-gray"></i>
            </button>

            <!-- Centered Page Title -->
            <h1 class="absolute left-1/2 transform -translate-x-1/2 text-lg font-bold text-neutral-gray">
                My Cart
            </h1>

            <!-- Empty spacer for balance -->
            <div class="w-10 h-10"></div>
        </div>
    </header>

    <!-- Sign-Up Prompt -->
    <div id="signup-prompt" class="bg-orange-100 p-4 text-center text-sm text-gray-700 mb-4 mx-4 rounded-lg hidden">
        Save your cart and proceed to checkout! <a href="/register.html" class="text-orange-500 hover:text-orange-600">Create an account</a> or <a href="/login.html" class="text-orange-500 hover:text-orange-600">log in</a>.
    </div>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-6 md:px-6 lg:max-w-4xl">
        <!-- Cart Items Loader -->
        <div id="cart-items-loader" class="space-y-4 hidden">
            <div class="bg-white rounded-xl p-4 shadow-sm">
                <div class="flex">
                    <div class="w-20 h-20 bg-gray-200 rounded-lg mr-4 cart-loader"></div>
                    <div class="flex-1 space-y-2">
                        <div class="h-5 w-3/4 bg-gray-200 rounded cart-loader"></div>
                        <div class="h-4 w-1/2 bg-gray-200 rounded cart-loader"></div>
                        <div class="flex items-center justify-between">
                            <div class="h-5 w-1/4 bg-gray-200 rounded cart-loader"></div>
                            <div class="flex items-center border border-gray-200 rounded-full">
                                <div class="h-6 w-8 bg-gray-200 rounded-l-full cart-loader"></div>
                                <div class="h-6 w-8 bg-gray-200 cart-loader"></div>
                                <div class="h-6 w-8 bg-gray-200 rounded-r-full cart-loader"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Cart Items -->
        <div class="space-y-4 mb-6" id="cart-items"></div>
        
        <!-- Order Summary -->
        <div class="bg-white rounded-xl p-4 shadow-sm mb-6 md:max-w-md md:mx-auto" id="order-summary">
            <div id="summary-loader" class="space-y-3 hidden">
                <div class="h-6 w-1/2 bg-gray-200 rounded cart-loader"></div>
                <div class="space-y-2">
                    <div class="flex justify-between">
                        <div class="h-4 w-1/3 bg-gray-200 rounded cart-loader"></div>
                        <div class="h-4 w-1/4 bg-gray-200 rounded cart-loader"></div>
                    </div>
                    <div class="flex justify-between">
                        <div class="h-4 w-1/3 bg-gray-200 rounded cart-loader"></div>
                        <div class="h-4 w-1/4 bg-gray-200 rounded cart-loader"></div>
                    </div>
                </div>
                <div class="border-t border-gray-200 pt-3">
                    <div class="flex justify-between">
                        <div class="h-5 w-1/4 bg-gray-200 rounded cart-loader"></div>
                        <div class="h-5 w-1/4 bg-gray-200 rounded cart-loader"></div>
                    </div>
                </div>
                <div class="h-10 w-full bg-gray-200 rounded-full cart-loader"></div>
            </div>
            <div id="summary-content">
                <h2 class="font-bold mb-3">Order Summary</h2>
                <div class="space-y-2 mb-4">
                    <div class="flex justify-between">
                        <span class="text-gray-600" id="subtotal-label">Subtotal (0 items)</span>
                        <span class="font-medium" id="subtotal">₦0</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Delivery Fee</span>
                        <span class="font-medium" id="delivery-fee">₦0</span>
                    </div>
                </div>
                <div class="border-t border-gray-200 pt-3 mb-4">
                    <div class="flex justify-between">
                        <span class="font-bold">Total</span>
                        <span class="font-bold text-orange-500" id="total">₦0</span>
                    </div>
                </div>
                <button class="w-full py-3 bg-orange-500 text-white rounded-full font-bold ripple" id="checkout-button" disabled>
                    Proceed to Checkout
                </button>
            </div>
        </div>
        
        <!-- Continue Shopping -->
        <div class="text-center">
            <button class="text-orange-500 font-medium flex items-center justify-center mx-auto ripple" onclick="window.location.href='/index.html'">
                <i data-feather="arrow-left" class="w-4 h-4 mr-1"></i>
                Continue Shopping
            </button>
        </div>
    </main>

    <!-- BOTTOM NAVIGATION REMOVED -->

    <script>
        feather.replace();

        const API_BASE_URL = 'https://pulse-parcel.onrender.com/api';
        const DELIVERY_FEE = 5000;

        function setupAuthUI() {
            const token = localStorage.getItem('token');
            const signupPrompt = document.getElementById('signup-prompt');
            if (signupPrompt) {
                signupPrompt.classList.toggle('hidden', !!token);
            }
        }

        function showShimmer() {
            document.getElementById('cart-items-loader')?.classList.remove('hidden');
            document.getElementById('summary-loader')?.classList.remove('hidden');
            document.getElementById('summary-content')?.classList.add('hidden');
            document.getElementById('cart-items').innerHTML = '';
        }

        function hideShimmer() {
            document.getElementById('cart-items-loader')?.classList.add('hidden');
            document.getElementById('summary-loader')?.classList.add('hidden');
            document.getElementById('summary-content')?.classList.remove('hidden');
        }

        async function fetchCart() {
            showShimmer();
            try {
                const token = localStorage.getItem('token');
                let cart = [];
                if (token) {
                    const res = await fetch(`${API_BASE_URL}/carts/me`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (res.status === 401) { localStorage.removeItem('token'); setupAuthUI(); return; }
                    if (!res.ok) throw new Error('Failed to load cart');
                    cart = (await res.json()).items || [];
                } else {
                    cart = JSON.parse(localStorage.getItem('guestCart') || '[]');
                }
                hideShimmer();
                renderCart(cart);
                updateOrderSummary(cart);
            } catch (err) {
                hideShimmer();
                document.getElementById('cart-items').innerHTML = '<p class="text-center text-gray-500">Failed to load cart.</p>';
            }
        }

        function renderCart(cart) {
            const container = document.getElementById('cart-items');
            if (cart.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500">Your cart is empty.</p>';
                document.getElementById('checkout-button').disabled = true;
                return;
            }
            container.innerHTML = cart.map(item => `
                <div class="bg-white rounded-xl p-4 shadow-sm cart-item">
                    <div class="flex">
                        <img src="${item.product.images[0]?.url || 'https://via.placeholder.com/80'}" alt="${item.product.name}" class="w-20 h-20 rounded-lg object-contain mr-4">
                        <div class="flex-1">
                            <div class="flex justify-between">
                                <h3 class="font-medium">${item.product.name}</h3>
                                <button onclick="removeFromCart('${item.product._id}')" class="ripple">
                                    <i data-feather="trash-2" class="w-5 h-5 text-gray-400 hover:text-red-500"></i>
                                </button>
                            </div>
                            <div class="flex items-center justify-between mt-3">
                                <p class="text-orange-500 font-bold">₦${item.product.price.toLocaleString()}</p>
                                <div class="flex items-center border rounded-full">
                                    <button onclick="updateQuantity('${item.product._id}', ${item.quantity - 1})" class="px-3 py-1 ripple"><i data-feather="minus"></i></button>
                                    <span class="px-3">${item.quantity}</span>
                                    <button onclick="updateQuantity('${item.product._id}', ${item.quantity + 1})" class="px-3 py-1 ripple"><i data-feather="plus"></i></button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
            feather.replace();
            document.getElementById('checkout-button').disabled = false;
        }

        function updateOrderSummary(cart) {
            const subtotal = cart.reduce((sum, i) => sum + i.product.price * i.quantity, 0);
            const items = cart.reduce((sum, i) => sum + i.quantity, 0);
            const total = subtotal + (items > 0 ? DELIVERY_FEE : 0);

            document.getElementById('subtotal-label').textContent = `Subtotal (${items} items)`;
            document.getElementById('subtotal').textContent = `₦${subtotal.toLocaleString()}`;
            document.getElementById('delivery-fee').textContent = items > 0 ? `₦${DELIVERY_FEE.toLocaleString()}` : '₦0';
            document.getElementById('total').textContent = `₦${total.toLocaleString()}`;
        }

        async function updateQuantity(id, qty) {
            if (qty < 1) return removeFromCart(id);
            const token = localStorage.getItem('token');
            if (token) {
                await fetch(`${API_BASE_URL}/carts/add`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ productId: id, quantity: qty })
                });
            } else {
                let guest = JSON.parse(localStorage.getItem('guestCart') || '[]');
                const idx = guest.findIndex(x => x.productId === id);
                if (idx > -1) guest[idx].quantity = qty;
                localStorage.setItem('guestCart', JSON.stringify(guest));
            }
            fetchCart();
        }

        async function removeFromCart(id) {
            const token = localStorage.getItem('token');
            if (token) {
                await fetch(`${API_BASE_URL}/carts/remove`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ productId: id })
                });
            } else {
                let guest = JSON.parse(localStorage.getItem('guestCart') || '[]');
                guest = guest.filter(x => x.productId !== id);
                localStorage.setItem('guestCart', JSON.stringify(guest));
            }
            fetchCart();
        }

        document.getElementById('checkout-button')?.addEventListener('click', () => {
            const token = localStorage.getItem('token');
            window.location.href = token ? '/checkout.html' : '/login.html?redirect=checkout';
        });

        document.addEventListener('DOMContentLoaded', () => {
            feather.replace();
            setupAuthUI();
            fetchCart();
        });
    </script>
</body>
</html>